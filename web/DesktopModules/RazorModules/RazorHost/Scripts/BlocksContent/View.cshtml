@using System.Collections;
@using System.IO;
@using System.Collections.Generic;
@using System.Data.SqlClient;
@using DotNetNuke.Entities.Tabs;
@using System.Data;
@using System.Linq;
@using DotNetNuke.Common;
@using DotNetNuke.Entities.Users;
@using DotNetNuke.Web.Api;
@using DotNetNuke;
@using DotNetNuke.Services.Localization;
@using DotNetNuke.Entities.Modules;
@using DotNetNuke.Security.Permissions;
@using Yemon.dnn.BlocksContent;
@{
    var moduleID = PageData["moduleID"];
    var blocksSuffix = PageData["blocksSuffix"];
    var Html = PageData["HTML"];

    List<Block> blocks = PageData["blocks"];
    if (blocks == null)
    {
        blocks = new List<Block>();
    }
    try
    {
        string sblocks = "" + Yemon.dnn.Helpers.GetItem("blockscontent:" + blocksSuffix);
        if (sblocks != "")
        {
            blocks = (List<Block>)Yemon.dnn.Functions.Deserialize(sblocks, typeof(List<Block>));
        }

    }
    catch
    {

    }

    foreach (Block block in blocks)
    {
        switch (block.Type)
        {
            case "ImageText":
                Block.ImageText p = (Block.ImageText)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.ImageText));
                switch (p.Position)
                {
                    case "G":
                        <div class="row">
                            @if (p.Title != null)
                            {
                                <h2 class="col-sm-12">@p.Title</h2>
                            }
                            @if (p.Image != null)
                            {
                                <div class="col-sm-6">
                                    <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                                </div>
                            }
                            @if (p.Html != null)
                            {
                                <div class="col-sm-6">@Html.Raw(p.Html)</div>
                            }
                        </div>
                        break;
                    case "D":
                        <div class="row">
                            @if (p.Title != null)
                            {
                                <h2 class="col-sm-12">@p.Title</h2>
                            }
                            @if (p.Html != null)
                            {
                                <div class="col-sm-6">@Html.Raw(p.Html)</div>
                            }
                            @if (p.Image != null)
                            {
                                <div class="col-sm-6">
                                    <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                                </div>
                            }

                        </div>
                        break;
                    case "B":
                        if (p.Title != null)
                        {
                            <h2>@p.Title</h2>
                        }
                        if (p.Html != null)
                        {
                            <div>@Html.Raw(p.Html)</div>
                        }
                        if (p.Image != null)
                        {
                            <div>
                                <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                            </div>
                        }
                        break;
                    default:
                        if (p.Title != null)
                        {
                            <h2>@p.Title</h2>
                        }
                        if (p.Image != null)
                        {
                            <div>
                                <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                            </div>
                        }
                        if (p.Html != null)
                        {
                            <div>@Html.Raw(p.Html)</div>
                        }
                        break;
                }
                break;
            case "FileCollection":
                Block.FileCollection fc = (Block.FileCollection)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.FileCollection));
                if (fc.Title != null)
                {
                    <h2>@fc.Title</h2>
                }
                if (fc.Files.Count > 0)
                {
                    <ul>
                        @foreach (var f in fc.Files)
                        {
                            <li>
                                <a href="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@f.GUID&noattach=true" class="btn btn-link" target="_blank" title="Ouvrir">@f.Name</a>&nbsp;
                                <a href="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@f.GUID" class="btn btn-link" target="_blank" title="Télécharger"><i class="fa fa-download" aria-hidden="true"></i></a>
                            </li>

                        }
                    </ul>
                }
                break;
            case "ImageCollection":
                Block.ImageCollection ic = (Block.ImageCollection)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.ImageCollection));
                if (ic.Title != null)
                {
                    <h2>@ic.Title</h2>
                }
                if (ic.Images.Count > 0)
                {
                    switch ("" + ic.Type)
                    {
                        case "":
                            foreach (var i in ic.Images)
                            {
                                <span>
                                    <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@i.GUID" width="100%" title="@i.Name" />
                                </span>
                            }
                            break;
                        case "gallery":
                            var images = Yemon.dnn.Functions.Serialize(ic.Images);
                            <script>
                                 if (!resize) {
                                var resize = [];
                            }
                            resize['@block.Guid'] = function () {
                                var gallery = document.getElementById('@("gallery"+block.Guid)');
                                var rect = gallery.getBoundingClientRect();
                                var width = rect.width;
                                const padding = 8;
                                const marginv = 8;

                                var y = [];
                                var col = 0;
                                var maxcol = Math.round(width / 300, 0);
                                var pct = Math.round(100 / maxcol, 0);
                                var colWidth = Math.round(width/ maxcol, 0);
                                for (var i = 0; i < maxcol; i++) {
                                    y.push(0);
                                }
                                
                                var images = @Html.Raw(images);
                                var maxheight = 0;
                                for (var i = 0; i < images.length; i++) {
                                    var c = document.getElementById(images[i].GUID);
                                    var im = images[i];
                                    let ratio = im.Height / im.Width;
                                    let height = Math.round(colWidth * ratio, 0) + marginv;
                                    let max = Number.MAX_SAFE_INTEGER;
                                    col = 0;
                                    for (var j = 0; j < maxcol; j++) {
                                        if (y[j] < max) {
                                            col = j;
                                            max = y[j];
                                        }
                                    }
                                
                                    c.style.top = y[col]+'px';
                                    c.style.left = col * colWidth + 'px';
                                    c.style.width = colWidth + 'px';
                                    c.style.height = height + 'px';
                                    c.style.padding = marginv + 'px ' + (padding / 2) + 'px 0px '+ (padding / 2) + 'px';
                                    y[col] += height;
                                    if (y[col] > maxheight)
                                        maxheight = y[col];

                                };
                                gallery.style.height = maxheight+ 'px';
                            };
                            $(window).resize(resize['@block.Guid']);
                            $(document).ready(function () {
                                resize['@block.Guid']();
                            });

                            </script>
                            <div id='@("gallery"+block.Guid)' style="position:relative">
                                @foreach(var i in ic.Images)
                                { 
                                    <img id="@i.GUID" src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@i.GUID" title="@i.Name" style="position:absolute" width="@i.Width" height="@i.Height" />
                                }
                                
                            </div>
                            break;
                    }

                }
                break;
            case "Raw":
                Block.Raw r = (Block.Raw)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.Raw));
                <div>@Html.Raw(r.Html)</div>
                break;
            case "Video":
                Block.Video v = (Block.Video)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.Video));
                if (v.Title != null)
                {
                    <h2>@v.Title</h2>
                }
                <div id="@("container" + block.Guid)">
                    <iframe width="100%" id="@("video" + block.Guid)" class="video" src="@v.Url" allowfullscreen=""></iframe>
                </div>
                <script>
                    if (!resize) {
                        var resize = [];
                    }
                    resize['@block.Guid'] = function() {


                        var ratio = 16 / 9;
                        const videoIFrame = document.getElementById('video@(block.Guid)');
                        const videoContainer = document.getElementById('container@(block.Guid)');
                        var width = Math.min(window.innerWidth, videoIFrame.offsetWidth);
                        videoIFrame.style.height = Math.ceil(width / ratio) + "px";
                        videoContainer.style.height = (width / ratio) + "px";
                    }
                    $(window).resize(resize['@block.Guid']);
                    $(document).ready(function () {
                        resize['@block.Guid']();
                    });

                </script>
                break;
        }
    }
}
