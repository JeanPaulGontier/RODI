<script type="text/x-template" id="blocknewscards-template">
    <div v-if="c">
        <div v-if="editing" class="bc-editing">
            <button type="button" v-on:click="cancel()" class="btn btn-close"><i class="fa fa-times"></i></button>
            <span class="bc-label">Titre :</span>
            <input type="text" v-model="e.Title" class="form-control" />
            <span class="bc-label">Description :</span>
            <input type="text" v-model="e.Description" class="form-control" />

            <span class="bc-label">Nouvelles district :</span>
            <div class="form-control">
                <label for="rod0" class="radio-inline"><input type="radio" v-model="e.District" :value="false" name="rod" id="rod0" />Non</label>
                <label for="rod1" class="radio-inline"><input type="radio" v-model="e.District" :value="true" name="rod" id="rod1" />Oui</label>
            </div>

            <div v-if="e.District==true">
                <span class="bc-label">Url de détail des nouvelles district :</span>
                <input type="text" class="form-control" v-model="e.Uri_District.Href" />
                <div class="form-inline">
                    <label for="targetd0" class="radio-inline"><input type="radio" v-model="e.Uri_District.Target" value="" name="targetd" id="targetd0" />Même fenêtre</label>
                    <label for="targetd1" class="radio-inline"><input type="radio" v-model="e.Uri_District.Target" value="_blank" name="targetd" id="targetd1" />Nouvelle fenêtre</label>
                </div>
            </div>

            <span class="bc-label">Nouvelles clubs :</span>
            <div class="form-control">
                <label for="roc0" class="radio-inline"><input type="radio" v-model="e.Clubs" :value="false" name="roc" id="roc0" />Non</label>
                <label for="roc1" class="radio-inline"><input type="radio" v-model="e.Clubs" :value="true" name="roc" id="roc1" />Oui</label>
            </div>

            <div v-if="e.Clubs==true">
                <span class="bc-label">Url de détail des nouvelles clubs :</span>
                <input type="text" v-model="e.Uri_Clubs.Href" class="form-control" />
                <span class="bc-label"></span>
                <div class="form-control">
                    <label for="targetc0" class="radio-inline"><input type="radio" v-model="e.Uri_Clubs.Target" value="" name="targetc" id="targetc0" />Même fenêtre</label>
                    <label for="targetc1" class="radio-inline"><input type="radio" v-model="e.Uri_Clubs.Target" value="_blank" name="targetc" id="targetc1" />Nouvelle fenêtre</label>
                </div>
            </div>




            <span class="bc-label">Afficher bouton en voir plus :</span>
            <div class="form-control">
                <label for="rotevp0" class="radio-inline"><input type="radio" v-model="e.Button_More" :value="false" name="rotevp" id="rotevp0" />Non</label>
                <label for="rotevp1" class="radio-inline"><input type="radio" v-model="e.Button_More" :value="true" name="rotevp" id="rotevp1" />Oui</label>
            </div>

            <div v-if="e.Button_More==true">
                <span class="bc-label">Url du bouton en voir plus :</span>
                <input type="text" v-model="e.Uri_All.Href" class="form-control" />
                <span class="bc-label"></span>
                <div class="form-control">
                    <label for="targete0" class="radio-inline"><input type="radio" v-model="e.Uri_All.Target" value="" name="targete" id="targete0" />Même fenêtre</label>
                    <label for="targete1" class="radio-inline"><input type="radio" v-model="e.Uri_All.Target" value="_blank" name="targete" id="targete1" />Nouvelle fenêtre</label>
                </div>
            </div>




            <span class="bc-label">Catégories incluses :</span>
            <textarea class="form-control" v-model="e.Tags_Included"></textarea>

            <span class="bc-label">Catégories exclues :</span>
            <textarea class="form-control" v-model="e.Tags_Excluded"></textarea>

            <span class="bc-label">Temporalité :</span>
            <div class="form-control">
                <label for="rot0" class="radio-inline"><input type="radio" v-model="e.Next" :value="false" name="rot" id="rot0" />Passées</label>
                <label for="rot1" class="radio-inline"><input type="radio" v-model="e.Next" :value="true" name="rot" id="rot1" />Futures</label>
            </div>

            <span class="bc-label">Nb maxi de nouvelles affichées :</span>
            <div class="form-control">
                <label for="rotnb3" class="radio-inline"><input type="radio" v-model="e.Nb_Max" :value="3" name="rotnb" id="rotnb3" />3</label>
                <label for="rotnb6" class="radio-inline"><input type="radio" v-model="e.Nb_Max" :value="6" name="rotnb" id="rotnb6" />6</label>
                <label for="rotnb9" class="radio-inline"><input type="radio" v-model="e.Nb_Max" :value="9" name="rotnb" id="rotnb9" />9</label>                
            </div>


            <span class="bc-label">Couleur :</span>
            <div class="form-control color-picker">
                <span v-for="(t,i) in colorsList">
                    <label :for="'color'+i" :style="{'background-color': t[0]}"> </label>
                    <input type="radio" v-model="color" name="color" :id="'color'+i" :value="t" />
                </span>
            </div>

            <span class="bc-label">Nouvelles Rotary International :</span>
            <div class="form-control">
                <label for="rori0" class="radio-inline"><input type="radio" v-model="e.RI" :value="false" name="rori" id="rori0" />Non</label>
                <label for="rori1" class="radio-inline"><input type="radio" v-model="e.RI" :value="true" name="rori" id="rori1" />Oui</label>
            </div>
            <em>La temporalité n'est pas appliquée sur les nouvelles du RI</em>

            <div style="text-align:center;margin-top:1em;">
                <button type="button" v-on:click="validate()" class="btn btn-primary">Valider</button>
            </div>
        </div>


        <div class="block-news-cards" v-if="!editing"> 
            <div class="content-wrapper">
                <div class="card-header">
                    <h3 :style="{color:c.Color}">{{c.Title}}</h3>
                    <p class="lead">{{c.Description}}</p>
                </div>
                <div v-if="!news" class="text-center">chargement en cours...</div>
                <div v-if="news && news.length==0" class="text-center">Aucune nouvelle trouvée, ajustez les paramètres...</div>
                <div class="grid" v-if="news">

                    <div class="card" v-for="n in news">
                        <a :href="uri(n)" :target="target(n)">
                            <img :src="n.photo" :alt="n.title" v-if="n.photo">
                            <span class="news-type" style="color:turquoise;">
                                <span>{{n.tag1}}</span>
                            </span>

                            <span class="news-date" v-if="n.tag1!='Rotary International'">{{date(n.dt)}}</span>
                            <span class="news-date" v-else></span>
                            <span class="news-title">{{n.title}}</span>

                            <span class="news-location" v-if="n.cric!=0"><i class="fa-solid fa-location-dot"></i> {{n.club_name}}</span>
                            <span class="news-link">pour en savoir plus <i class="fa-solid fa-square-full" style="color: turquoise;"></i></span>
                        </a>
                    </div>


                </div>
                <div class="text-center" v-if="c.Uri_All && news && news.length>0">
                    <a :href="c.Uri_All.Href" :target="c.Uri_All.Target" class="btn btn-outline">en voir plus...</a>
                </div>
            </div>
        </div>
    </div>
</script>
<script>
    if (typeof BlockNewsCards == 'undefined') {

        BlockNewsCards = {
            template: '#blocknewscards-template',
            name: 'BlockNewsCards',
            props: [
                'content',
                'moduleid'
            ],
            emits: [
                'changed',
                'cancel'
            ],
            data() {
                return {
                    news: null,
                    redirectOnClick: false,
                    colorsList: BGCOLORSLIST,
                    editing: false,
                    color: null,
                    c: {
                    },
                    fichiers: [],
                    e: {
                        District: false,
                        Clubs: false,
                        Next: true,
                        Tags_Included: '',
                        Tags_Excluded: '',
                        Color: null,
                        Uri_District: { Href: '', Target: '' },
                        Uri_Clubs: { Href: '', Target: '' },
                        Uri_All: { Href: '', Target: '' },
                        RI: false,
                        Nb_Max: 3,
                        Button_More:false
                    },



                }
            },
            components: {

            },
            methods: {
                uri(n) {
                    if (n.tag1 == "Rotary International")
                        return n.url;
                    if (n.cric == 0) {
                        return this.c.Uri_District.Href + n.id;
                    }
                    return this.c.Uri_Clubs.Href + n.id;

                },
                target(n) {
                    if (n.cric == 0) {
                        return this.c.Uri_District.Target;
                    }
                    return this.c.Uri_Clubs.Target;

                },
                date(d) {
                    if (!d)
                        return '';
                    let dd = new Date(d);
                    return dd.toLocaleDateString();
                },
                getNews() {
                    
                    if (!this.c.Uri_District)
                        this.c.Uri_District = { Href: '', Target: '' };
                    if (!this.c.Uri_Clubs)
                        this.c.Uri_Clubs = { Href: '', Target: '' };
                    if (!this.c.Uri_All)
                        this.c.Uri_All = { Href: '', Target: '' };
                    if (!this.c.RI)
                        this.c.RI = false;
                    if (!this.c.Nb_Max)
                        this.c.Nb_Max = 3;
                    if (!this.c.Button_More)
                        this.c.Button_More = false;
                    _yemonNews[this.moduleid].service.getData('/GetBlockContentNews',
                        {
                            district: this.c.District,
                            clubs: this.c.Clubs,
                            next: this.c.Next,
                            tags_included: this.c.Tags_Included,
                            tags_excluded: this.c.Tags_Excluded,
                            ri: this.c.RI,
                            nb_max: this.c.Nb_Max
                        },
                        (r) => {
                            this.news = JSON.parse(r.data);
                            this.news.forEach(n => {                               
                                if (!n.Uri_District)
                                    n.Uri_District = { Href: '', Target: '' };
                                if (!n.Uri_Clubs)
                                    n.Uri_Clubs = { Href: '', Target: '' };
                                if (!n.Uri_All)
                                    n.Uri_All = { Href: '', Target: '' };
                                if (!n.RI)
                                    n.RI = false;
                                if (!n.Nb_Max)
                                    n.Nb_Max = 3;
                                if (!n.Button_More)
                                    n.Button_More = false;
                            });
                        },
                        (e) => {
                            console.log(e);
                        }

                    );
                },
                edit() {
                    this.editing = true;
                    this.e = JSON.parse(JSON.stringify(this.c));
                    var i = this.colorsList.findIndex(c => c[0] == this.e.Color);
                    if (i > -1)
                        this.color = this.colorsList[i];
                    else
                        this.color = this.colorsList[0];
                    if (!this.e.Uri_District)
                        this.e.Uri_District = { Href: '', Target: '' };
                    if (!this.e.Uri_Clubs)
                        this.e.Uri_Clubs = { Href: '', Target: '' };
                    if (!this.e.Uri_All)
                        this.e.Uri_All = { Href: '', Target: '' };
                    if (!this.e.RI)
                        this.e.RI = false;
                    if (!this.e.Nb_Max)
                        this.e.Nb_Max = 3;
                    if (!this.e.Button_More)
                        this.e.Button_More = false;
                },
                validate() {
                    this.c = JSON.parse(JSON.stringify(this.e));
                    this.c.Color = this.color[0];
                    if (!this.c.Tags_Included)
                        this.c.Tags_Included = '';
                    if (!this.c.Tags_Excluded)
                        this.c.Tags_Excluded = '';
                    if (!this.c.Uri_District)
                        this.c.Uri_District = { Href: '', Target: '' };
                    if (!this.c.Uri_Clubs)
                        this.c.Uri_Clubs = { Href: '', Target: '' };
                    if (!this.c.Uri_All)
                        this.c.Uri_All = { Href: '', Target: '' };
                    if (!this.c.RI)
                        this.c.RI = false;
                    if (!this.c.Nb_Max)
                        this.c.Nb_Max = 3;
                    if (!this.c.Button_More)
                        this.c.Button_More = false;

                    this.editing = false;
                    this.onChange();
                    this.getNews();
                },
                cancel() {
                    this.editing = false;
                    this.$emit('cancel');
                },
                onChange() {
                    this.$emit('changed', this.c);
                },


            },
            mounted() {
                this.c = this.content;
                this.getNews();
            }
        }
    }


</script>