@using System.Collections;
@using System.IO;
@using System.Collections.Generic;
@using System.Data.SqlClient;
@using DotNetNuke.Entities.Tabs;
@using System.Data;
@using System.Linq;
@using DotNetNuke.Common;
@using DotNetNuke.Entities.Users;
@using DotNetNuke.Web.Api;
@using DotNetNuke;
@using DotNetNuke.Services.Localization;
@using DotNetNuke.Entities.Modules;
@using DotNetNuke.Security.Permissions;
@using AIS;
@{
    var moduleID = PageData["moduleID"];
    var blocksSuffix = PageData["blocksSuffix"];
    var Html = PageData["HTML"];

    string club_url = Request.Url.ToString();
    string seo = Request.QueryString["sn"];
    int cric = 0;

    if (seo != null && seo != "")
    {
        Club club = DataMapping.GetClubBySeo(seo);
        if (club == null)
        {
            return;
        }
        if (club.seo_mode == "m")
        {
            club_url = "/" + club.seo;
        }
        if (club.seo_mode == "d")
        {
            club_url = "https://" + club.domaine;
        }
        cric = club.cric;
    }


    List<Block> blocks = PageData["blocks"];
    if (blocks == null)
    {
        blocks = new List<Block>();
    }
    try
    {
        string sblocks = "" + Yemon.dnn.Helpers.GetItem("blockscontent:" + blocksSuffix);
        if (sblocks != "")
        {
            blocks = (List<Block>)Yemon.dnn.Functions.Deserialize(sblocks, typeof(List<Block>));
        }

    }
    catch
    {

    }

    foreach (Block block in blocks)
    {
        switch (block.Type)
        {
            case "ImageText":
                Block.ImageText p = (Block.ImageText)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.ImageText));
                switch (p.Position)
                {
                    case "G":
                        <div class="row">
                            @if (p.Title != null)
                            {
                                <h2 class="col-sm-12">@p.Title</h2>
                            }
                            @if (p.Image != null)
                            {
                                <div class="col-sm-6">
                                    <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                                </div>
                            }
                            @if (p.Html != null)
                            {
                                <div class="col-sm-6">@Html.Raw(p.Html)</div>
                            }
                        </div>
                        break;
                    case "D":
                        <div class="row">
                            @if (p.Title != null)
                            {
                                <h2 class="col-sm-12">@p.Title</h2>
                            }
                            @if (p.Html != null)
                            {
                                <div class="col-sm-6">@Html.Raw(p.Html)</div>
                            }
                            @if (p.Image != null)
                            {
                                <div class="col-sm-6">
                                    <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                                </div>
                            }

                        </div>
                        break;
                    case "B":
                        if (p.Title != null)
                        {
                            <h2>@p.Title</h2>
                        }
                        if (p.Html != null)
                        {
                            <div>@Html.Raw(p.Html)</div>
                        }
                        if (p.Image != null)
                        {
                            <div>
                                <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                            </div>
                        }
                        break;
                    default:
                        if (p.Title != null)
                        {
                            <h2>@p.Title</h2>
                        }
                        if (p.Image != null)
                        {
                            <div>
                                <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@p.Image.GUID" title="@p.Image.Name" />
                            </div>
                        }
                        if (p.Html != null)
                        {
                            <div>@Html.Raw(p.Html)</div>
                        }
                        break;
                }
                break;
            case "FileCollection":
                Block.FileCollection fc = (Block.FileCollection)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.FileCollection));
                if (fc.Title != null)
                {
                    <h2>@fc.Title</h2>
                }
                if (fc.Files.Count > 0)
                {
                    <ul>
                        @foreach (var f in fc.Files)
                        {
                            <li>
                                <a href="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@f.GUID&noattach=true" class="btn btn-link" target="_blank" title="Ouvrir">@f.Name</a>&nbsp;
                                <a href="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@f.GUID" class="btn btn-link" target="_blank" title="Télécharger"><i class="fa fa-download" aria-hidden="true"></i></a>
                            </li>

                        }
                    </ul>
                }
                break;
            case "ImageCollection":
                Block.ImageCollection ic = (Block.ImageCollection)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.ImageCollection));
                if (ic.Title != null)
                {
                    <h2>@ic.Title</h2>
                }
                if (ic.Images.Count > 0)
                {
                    foreach (var i in ic.Images)
                    {
                        <span>
                            <img src="/DesktopModules/BlocksContent/API/Blocks/getMedia?guid=@i.GUID" width="100%" title="@i.Name" />
                        </span>
                    }

                }
                break;
            case "Raw":
                Block.Raw r = (Block.Raw)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.Raw));
                <div>@Html.Raw(r.Html)</div>
                break;
            case "Video":
                Block.Video v = (Block.Video)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.Video));
                if (v.Title != null)
                {
                    <h2>@v.Title</h2>
                }
                <div id="@("container" + block.Guid)">
                    <iframe width="100%" id="@("video" + block.Guid)" class="video" src="@v.Url" allowfullscreen=""></iframe>
                </div>
                <script>
                    if (!resize) {
                        var resize = [];
                    }
                    resize['@block.Guid'] = function() {


                        var ratio = 16 / 9;
                        const videoIFrame = document.getElementById('video@(block.Guid)');
                        const videoContainer = document.getElementById('container@(block.Guid)');
                        var width = Math.min(window.innerWidth, videoIFrame.offsetWidth);
                        videoIFrame.style.height = Math.ceil(width / ratio) + "px";
                        videoContainer.style.height = (width / ratio) + "px";
                    }
                    $(window).resize(resize['@block.Guid']);
                    $(document).ready(function () {
                        resize['@block.Guid']();
                    });

                </script>
                break;
            case "NewsClub":
                Block.NewsClub nc = (Block.NewsClub)Yemon.dnn.Functions.Deserialize("" + block.Content, typeof(Block.NewsClub));
                if (seo != null && seo != "")
                {
                    Club club = DataMapping.GetClubBySeo(seo);

                    var sort = "dt asc";
                    if (nc.DateBehavior == "past")
                    {
                        sort = "dt desc";
                    }
                    List<News> newslistsrc = DataMapping.ListNews(club.cric, onlyvisible: true, category: "Clubs", sort: sort);

                    List<News> newslist = new List<News>();
                    var today = new DateTime(DateTime.Now.Year,DateTime.Now.Month,DateTime.Now.Day);
                    foreach(var n in newslistsrc)
                    {
                        if (nc.DateBehavior == "past")
                        {
                            if (DateTime.Compare(n.dt,today) < 0)
                            {
                                newslist.Add(n);
                            }

                        }
                        else
                        {
                            if (DateTime.Compare(n.dt, today) >= 0)
                            {
                                newslist.Add(n);
                            }
                        }

                    }
                    if (newslist.Count > 0)
                    {
                        if (nc.Title != null)
                        {
                            <h2>@nc.Title</h2>
                        }
                        <ul style="list-style:none;margin:0;padding:0">
                            @{ 
                                int i = 0;
                                while (i <nc.NBToShow && i<newslist.Count)
                                {
                                    var n = newslist[i];

                                   <li  style="list-style:none" class="BlocBlanc">
                                        <a href="@club_url/nouvelles?newsid=@n.id">
                                            @if(nc.ShowImage)
                                            { 
                                                <div>
                                                    <img src="@n.GetPhoto()"/>
                                                </div>
                                            }
                                            @if(nc.ShowTitle)
                                            { 
                                            <h3>
                                                <span>@n.title</span>
                                            </h3>
                                            }
                                            @if (nc.ShowDate)
                                            {
                                                <div class="text-right"><span class="Date">@n.dt.ToString("dd/MM/yyyy")</span></div>
                                            }
                                        </a>
                                    </li>
                                    i++;
                                }

                            }
                           

                            
                        </ul>

                    }

                                        }

                                        break;
                                    }
                                }
}
