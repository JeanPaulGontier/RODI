@using AIS
@using System.Data.SqlClient
@using System.Data
@{
    string d = "" + Request["debut"];
    string f = "" + Request["fin"];
    string c = "" + Request["club"];

    DateTime debut = DateTime.Now.AddMonths(-2);
    DateTime fin = DateTime.Now;

    if (d!="")
    {
        DateTime.TryParse(d, out debut);
    }
    if (f!="")
    {
        DateTime.TryParse(f, out fin);
    }
    string sqlclub = "";
    if (c!="")
    {
        sqlclub = " and clubid="+c+" ";
    }

    var sql = new SqlCommand("select *,(select top 1 name from ais_clubs where cric=M.ClubId) as club_name from ais_ri_member_terminated M where TerminationDate >@debut and TerminationDate<@fin "+sqlclub+" order by TerminationDate");
    sql.Parameters.AddWithValue("debut", debut.AddDays(-1));
    sql.Parameters.AddWithValue("fin", fin.AddDays(1));

    var table = Yemon.dnn.DataMapping.ExecSql(sql);

    <div class="form-inline">
        <label for="debut">Période entre</label>&nbsp;<input type="date" id="debut" name="debut" class="form-control" value="@debut.ToString("yyyy-MM-dd")" />&nbsp;
        <label for="fin">et</label>&nbsp;<input type="date" id="fin" name="fin" class="form-control" value="@fin.ToString("yyyy-MM-dd")" />&nbsp;
        <label for="club">club</label>&nbsp;
        <select name="club" id="club" class="form-control" style="margin-bottom:8px">
            <option value="">--- TOUS LES CLUBS ---</option>
            @foreach (var club in DataMapping.ListClubs(sort: "name"))
            {
                <option value="@club.cric" @(c==""+club.cric ? "selected" : "")>@club.name</option>
            }
        </select>
        <button class="btn btn-primary" style="margin-bottom:8px">Mettre à jour</button>
    </div>

    if (table==null || table.Rows.Count==0)
    {
        <div class="alert alert-warning">Aucun membre terminé sur la période...</div>
    }
    else
    {
        <div class="text-right"><small>@table.Rows.Count membre(s) trouvé(s)...</small></div>
        <table class="table table-striped">
            <tr>
                <th>Club</th>
                <th>Nim</th>
                <th>Prénom / Nom</th>
                <th>Type membre</th>
                <th>Date fin</th>
                <th>Raison</th>
            </tr>
            @foreach (DataRow row in table.Rows)
            {
                <tr>
                    <td>@row["club_name"]</td>
                    <td>@row["memberid"]</td>
                    <td>@row["LastName"] @row["FirstName"]</td>
                    <td>@row["MemberType"]</td>
                    <td>@(((DateTime)row["TerminationDate"]).ToShortDateString())</td>
                    <td>@row["TerminationReason"]</td>
                </tr>
            }
        </table>
    }
}




