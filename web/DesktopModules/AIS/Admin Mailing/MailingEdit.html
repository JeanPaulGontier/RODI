<script type="text/x-template" id="mailingedit-template">
    <div class="text-center">
        <router-link :to="{name: 'dest', params: {id: $route.params.id}}">Destinataires</router-link> |
        <router-link :to="{name: 'content', params: {id: $route.params.id}}">Contenu</router-link> |
        <router-link :to="{name: 'preview', params: {id: $route.params.id}}">Prévisualisation</router-link> |
        <router-link :to="{name: 'send', params: {id: $route.params.id}}">Envoi</router-link>
    </div>

    <router-view></router-view>
</script>


<script type="text/x-template" id="mailingeditdest-template">
    <h3>Paramètres</h3>
    <div class="row">
        <div class="col-sm-3">
            E-mail de l'expéditeur :
        </div>
        <div class="col-sm-4">
            <input type="text" class="form-control" />
        </div>
        <div class="col-sm-2">
            Nom de l'expéditeur :
        </div>
        <div class="col-sm-3">
            <input type="text" class="form-control" />
        </div>
    </div>
    <div class="row">
        <div class="col-sm-3">
            Titre du message :
        </div>
        <div class="col-sm-9">
            <input type="text" class="form-control" />
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <h3>Destinataires</h3>
    <div class="row">
        <div class="col-sm-4">
            <label class="checkbox-inline"><input type="checkbox">ADG 2022-2023 (20)</label>
        </div>
        <div class="col-sm-4">
            <label class="checkbox-inline"><input type="checkbox">Présidents 2022-2023 (86)</label>
        </div>
        <div class="col-sm-4">
            <label class="checkbox-inline"><input type="checkbox">Tous les membres (1200)</label>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="text-center">
        <router-link to="/" class="btn btn-default">Retour</router-link>&nbsp;
        <router-link :to="{name: 'content', params: {id: $route.params.id}}" class="btn btn-primary">Suivant</router-link>
    </div>

</script>


<script type="text/x-template" id="mailingeditcontent-template">
    <h3>Contenu</h3>
    <div class="text-center">
        <div style="width:600px;margin:0 auto;" class="bc-dotted">
            <button class="btn btn-primary">Ajouter un bloc</button>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="text-center">
        <router-link :to="{name: 'dest', params: {id: $route.params.id}}" class="btn btn-default">Retour</router-link>&nbsp;
        <router-link :to="{name: 'preview', params: {id: $route.params.id}}" class="btn btn-primary">Suivant</router-link>
    </div>
</script>


<script type="text/x-template" id="mailingeditpreview-template">
    <h3>Prévisualisation</h3>
    <div class="pe-spacer size20"></div>
    <div class="row">
        <div class="col-sm-3">
            Envoyer un e-mail de test :
        </div>
        <div class="col-sm-6">
            <input type="text" class="form-control" placeholder="saisir ici l'e-mail qui recevra le test" />
        </div>
        <div class="col-sm-3">
            <button class="btn btn-sm btn-primary">Tester</button>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="text-center">
        <router-link :to="{name: 'content', params: {id: $route.params.id}}" class="btn btn-default">Retour</router-link>&nbsp;
        <router-link :to="{name: 'send', params: {id: $route.params.id}}" class="btn btn-primary">Suivant</router-link>
    </div>
</script>


<script type="text/x-template" id="mailingeditsend-template">
    <h3>Envoi</h3>
    <div class="row">
        <p class="col-sm-10">
            <strong>Ceci est le titre de mon message</strong>
        </p>
        <div class="col-sm-2 text-right">
            <router-link :to="{name: 'dest', params: {id: $route.params.id}}" class="btn btn-sm btn-primary">Modifier</router-link>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="row">
        <p class="col-sm-10">
            A envoyer à la liste <strong>ADG 2022-2023 (20 destinataires)</strong>
        </p>
        <div class="col-sm-2 text-right">
            <router-link :to="{name: 'dest', params: {id: $route.params.id}}" class="btn btn-sm btn-primary">Modifier</router-link>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="row">
        <p class="col-sm-10">
            ... contenu du message (preview) ...
        </p>
        <div class="col-sm-2 text-right">
            <router-link :to="{name: 'content', params: {id: $route.params.id}}" class="btn btn-sm btn-primary">Modifier</router-link>
        </div>
    </div>
    <div class="pe-spacer size20"></div>
    <div class="text-center">
        <button class="btn btn-default">Programmer l'envoi</button>&nbsp;
        <button class="btn btn-success">Envoyer maintenant</button>
    </div>
</script>


<script>
    const MailingEditDest = {
        template: '#mailingeditdest-template',
        name: 'MailingEditDest'
    };
    const MailingEditContent = {
        template: '#mailingeditcontent-template',
        name: 'MailingEditContent'
    };
    const MailingEditPreview = {
        template: '#mailingeditpreview-template',
        name: 'MailingEditPreview'
    };
    const MailingEditSend = {
        template: '#mailingeditsend-template',
        name: 'MailingEditSend'
    };

    const MailingEdit = {
        template: '#mailingedit-template',
        name: 'MailingEdit',
        props: {
            moduleid: Number,
            context: Object,
            id: String,
            editable: Boolean
        },
        data: function () {
            return {
                blocks: [],
                mailing: {},
                blocks: [],
                fichiers: [],
                categories: CATEGORIES
            }
        },
        filters: {
            date: function (d) {
                if (!d)
                    return '';
                let dd = new Date(d);
                return dd.toLocaleDateString();
            }
        },
        components: {
            BlocksEditor
        },
        methods: {
            isValid() {
                return this.mailing.title && this.mailing.dt && this.mailing.tag1 && this.mailing.visible;

            },
            addDocument(event) {
                event.preventDefault();
                this.$refs.document.click();
            },
            onChangeDocumentUpload() {
                if (this.$refs.document.files.length == 0)
                    return;
                this.fichiers.push({
                    file: this.$refs.document.files[0],
                    uploaded: false
                });
                this.uploadMedia({
                    type: 'photo'
                }, this.onDocumentUploaded, (r) => { alert('une erreur est survenue, veuillez re-tenter ou nous contacter') });
            },
            onDocumentUploaded(r) {

                console.log('onDocumentUploaded', r);
                this.mailing.photo = r.data.GUID;
                this.fichiers = [];
            },
            uploadMedia(meta, callbackok, callbackerror) {
                let fichier = this.fichiers[this.fichiers.length - 1];
                if (fichier.file.size > 5 * 1024 * 1024) {
                    alert('Le fichier est trop gros, taille maximum 5Mo, veuillez re-tenter avec un fichier plus petit ou nous contacter');
                    this.fichiers = [];
                    return;
                }
                let formData = new FormData();
                formData.append('file', fichier.file);
                if (meta) {
                    for (let p in meta) {
                        formData.append(p, meta[p]);
                    }
                }
                _yemon[this.moduleid].service.postFile('/setMedia',
                    formData,
                    (r) => callbackok(r),
                    (r) => callbackerror(r)
                );

            },

            deleteMailing() {
                if (confirm("Supprimer la nouvelle ?")) {
                    _yemon[this.moduleid].service.getData("/DeleteMailing", {
                        guid: this.mailing.guid
                    }, (r) => {
                        this.$router.push("/");

                    }, (e) => {
                        toastr["error"]("Erreur : " + e.response.data.Message);
                    })

                   
                }
            },

            valider() {
                let b = JSON.parse(JSON.stringify(this.blocks));
                for (let i = 0; i < b.length; i++)
                    b[i].Content = JSON.stringify(b[i].Content);

                _yemon[this.moduleid].service.postData("/SetNews", {
                    context: this.context.context,
                    news: JSON.stringify(this.news),
                    blocks: JSON.stringify(b)
                }, (r) => {
                    this.$router.push("/");
                   
                }, (e) => {
                    toastr["error"]("Erreur : " + e.response.data.Message);
                })
                
            },

            cancel() {
                this.$router.push("/");
            },
            getBlocks() {
                _yemon[this.moduleid].service.getData("/GetItem", {
                    name: 'blockscontent:' + this.id
                }, (r) => {
                    this.blocks = [];
                    if (r.data) {
                        this.blocks = JSON.parse(r.data);
                        for (let i = 0; i < this.blocks.length; i++)
                            this.blocks[i].Content = JSON.parse(this.blocks[i].Content);
                    }
                    this.$forceUpdate();
                }, (e) => {
                    toastr["error"]("Erreur : " + e.response.data.Message);
                })
            },
            getMailingDetail() {
                _yemon[this.moduleid].service.getData("/GetMailingDetail", {
                    guid: this.id
                }, (r) => {
                    this.mailing = {};
                    if (r.data == 'null') {
                        this.$router.push("/");
                    }
                    else if (r.data) {
                        this.mailing = JSON.parse(r.data);
                        this.mailing.dt = new Date(this.mailing.dt + 'Z').toISOString().substr(0, 10);
                        this.getBlocks();
                    }
                    else {
                        this.$router.push("/");
                    }
                    this.$forceUpdate();
                }, (e) => {
                    toastr["error"]("Erreur : " + e.response.data.Message);
                })
            },
            //changed(data) {
            //    if (!data)
            //        return;

            //    _yemon[this.moduleid].service.postData("/SetItem", {
            //        name: 'blockscontent:' + this.moduleid,
            //        value: JSON.stringify(data),
            //        keephistory: false
            //    }, (r) => {
            //        //this.changed = false;
            //        //toastr["success"]("enregistrée");

            //    }, (e) => {
            //        toastr["error"]("Erreur : " + e.response.data);
            //    })
            //}


        },
        mounted() {
            //this.getBlocks();
            if (!this.editable) {
                this.$router.push("/");
                return;
            }
            if (this.id != "new") {
                this.getMailingDetail();
            }

            window.scrollTo(window.scrollX, 0);
        }
    }
</script>