<script type="text/x-template" id="news-template">
    <div v-if="context.mode=='clubs' && context.cric==0">
        <div class="panel-body">
            Veuillez choisir un club...
        </div>
    </div>
    <div v-if="context.mode=='clubs' && context.cric>0">
        <div v-if="news.length==0" class="panel-body">Aucune nouvelle pour le moment...</div>
        <button type="button" v-on:click="addNews()" class="btn btn-primary" v-show="editable">Ajouter une nouvelle</button>
        <div>&nbsp;</div>
        <table class="table table-striped table-hover" v-if="news.length>0">
            <tbody>
                <tr>
                    <th class="col-sm-1">Date</th>
                    <th class="col-sm-8">Titre</th>
                    <th class="col-sm-1">Catégorie</th>
                    <th class="col-sm-2">Visibilité</th>
                </tr>
                <tr v-for="n in news" v-on:click="editNews(n)">
                    <td>{{date(n.dt)}}</td>
                    <td>{{n.title}}</td>
                    <td>{{n.tag1}}</td>
                    <td>{{visibility(n)}}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div v-if="context.mode=='district'">
        <div v-if="news.length==0" class="panel-body">Aucune nouvelle pour le moment...</div>
        <button type="button" v-on:click="addNews()" class="btn btn-primary" v-show="editable">Ajouter une nouvelle</button>
        <div>&nbsp;</div>
        <table class="table table-striped table-hover" v-if="news.length>0">
            <tbody>
                <tr>
                    <th class="col-sm-1">Date</th>
                    <th class="col-sm-8">Titre</th>
                    <th class="col-sm-1">Catégorie</th>
                    <th class="col-sm-2">Visibilité</th>
                </tr>
                <tr v-for="n in news" v-on:click="editNews(n)">
                    <td>{{date(n.dt)}}</td>
                    <td>{{n.title}}</td>
                    <td>{{n.tag1}}</td>
                    <td>{{visibility(n)}}</td>
                </tr>
            </tbody>
        </table>
    </div>
</script>
<script>
    const News = {
        template: '#news-template',
        name: 'News',
        props: {
          moduleid: Number,
          context: Object,
          editable: Boolean
        },
        data: function () {
            return {
                d: null,
                news:[]
            }
        },
      
        methods: {
            date(d) {
                if (!d)
                    return '';
                let dd = new Date(d);
                return dd.toLocaleDateString();
            },
            visibility(n) {
                switch (n.visible) {
                    case "O":
                        return "Tout le monde";
                        break;
                    case "N":
                        return "Personne";
                        break;
                    case "M":
                        return "Membres du club";
                        break;
                    case "D":
                        return "Rotariens";
                        break;
                }
                return "";
            },
            editNews(n) {
                sessionStorage.setItem(window.location.pathname + ":scroll", window.scrollY);
                if(this.editable)
                    this.$router.push("/edit/" + n.id);
                else
                    this.$router.push("/view/" + n.id);
            },
            getNews() {
                _yemon[this.moduleid].service.getData("/GetNews", {
                    context: this.context.context
                }, (r) => {
                  this.news = [];
                    if (r.data) {
                      this.news = JSON.parse(r.data);
                    }
                    this.$forceUpdate();
                }, (e) => {
                    toastr["error"]("Erreur : " + e.response.data);
                })
            },
            addNews() {
                this.$router.push("/edit/new");
            }
        },
        mounted() {
            if (this.context.mode == 'clubs' && this.context.cric == 0)
                return;

            let lastScroll = sessionStorage.getItem(window.location.pathname + ":scroll");
            if (lastScroll)
                window.scrollTo(window.scrollX, parseInt(lastScroll));
            this.getNews();
        }
    }
</script>